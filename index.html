<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¾éº— æ–‡å­—åˆ—ç½®æ›ãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root{
      --bg: radial-gradient(1200px 800px at 10% 10%, #e9f0ff 0%, #f7e9ff 30%, #fff 70%),
            linear-gradient(120deg, #eef3ff, #fff);
      --card: #ffffffee;
      --ink: #1d2433;
      --muted: #637081;
      --accent: #7c3aed;
      --accent-2: #22c55e;
      --ring: 0 0 0 8px rgba(124,58,237,.08);
      --shadow: 0 20px 40px rgba(15, 23, 42, .12);
      --mark-bg: #fff1a6;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: radial-gradient(1200px 800px at 10% 10%, #0b1220 0%, #0d0f1a 50%, #0b1220 100%);
        --card: #0f172acc;
        --ink: #e5e7eb;
        --muted: #94a3b8;
        --accent: #8b5cf6;
        --accent-2: #34d399;
        --ring: 0 0 0 8px rgba(139,92,246,.15);
        --shadow: 0 20px 50px rgba(0,0,0,.45);
        --mark-bg: #3a3a00;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink); background:var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      min-height:100svh; display:flex; align-items:flex-start; justify-content:center; padding:24px;
    }
    .wrap{width:min(1200px, 100%);}
    header{display:flex; align-items:center; gap:16px; margin-bottom:20px}
    .logo{display:grid; place-items:center; width:52px; height:52px; border-radius:16px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow);}
    .logo svg{filter:drop-shadow(0 6px 12px rgba(0,0,0,.2))}
    h1{margin:0; font-size:clamp(22px, 2.4vw, 32px)}
    .sub{color:var(--muted)}

    .grid{display:grid; gap:16px; grid-template-columns: 1.2fr .8fr;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card); border-radius:24px; padding:18px; box-shadow:var(--shadow); backdrop-filter: blur(8px);}
    .card h2{margin:6px 0 14px; font-size:18px}

    .row{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end;}
    .row .btns{display:flex; gap:8px; flex-wrap:wrap}

    label{display:block; font-size:13px; color:var(--muted); margin:8px 0 6px}
    textarea, input[type="text"]{
      width:100%; border:none; outline:none; border-radius:16px; padding:14px 16px; background:#ffffff; color:#0f172a; min-height:120px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      textarea, input[type="text"]{background:#0b1220; color:#e5e7eb; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08)}
    }
    textarea:focus, input[type="text"]:focus{box-shadow: inset 0 0 0 1px transparent, var(--ring)}

    .mini{min-height:auto}
    .hint{font-size:12px; color:var(--muted); margin-top:4px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0}
    .pill{appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:999px; background:#fff; box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
      transition:.15s transform ease, .15s box-shadow ease; font-weight:600}
    .pill:hover{transform: translateY(-1px)}
    .pill:active{transform: translateY(0)}

    .primary{background:linear-gradient(135deg, var(--accent), #5eead4); color:white; box-shadow:0 10px 20px rgba(124,58,237,.35)}
    .ghost{background:transparent; color:var(--ink); box-shadow: inset 0 0 0 1px rgba(124,58,237,.25)}

    .flags{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0}
    .flag{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#fff; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06)}
    @media (prefers-color-scheme: dark){ .flag{background:#0b1220; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06)} }

    .stat{font-variation-settings:'wght' 700; font-weight:700;}

    .preview{white-space:pre-wrap; line-height:1.6; padding:16px; border-radius:16px; background: #fff; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06); max-height:420px; overflow:auto}
    @media (prefers-color-scheme: dark){ .preview{background:#0b1220; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06)} }

    mark{background:var(--mark-bg); border-radius:6px; padding:1px 3px}
    .footer{display:flex; justify-content:space-between; align-items:center; color:var(--muted); margin-top:10px}
    .counter{font-feature-settings:"tnum" on, "cv01" on; letter-spacing:.2px}

    .inline{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 640px){ .inline{grid-template-columns:1fr} }

    .error{color:#ef4444; font-size:13px; margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3l3.5 6H8.5L12 3Z" fill="white"/>
          <rect x="5" y="10" width="14" height="10" rx="3" fill="white" opacity=".85"/>
        </svg>
      </div>
      <div>
        <h1>ç¾éº— æ–‡å­—åˆ—ç½®æ›ãƒ„ãƒ¼ãƒ«</h1>
        <div class="sub">æ­£è¦è¡¨ç¾ã§ã‚‚é€šå¸¸æ–‡å­—åˆ—ã§ã‚‚ç½®æ›ã€‚\n ã¯æ”¹è¡Œã«ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å¼·èª¿è¡¨ç¤ºã€‚</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: inputs -->
      <section class="card">
        <h2>å…¥åŠ›</h2>
        <label for="source">å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ</label>
        <textarea id="source" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘â€¦">è¡Œ1: Apple\nè¡Œ2: apple\nè¡Œ3: Pineapple</textarea>

        <div class="inline">
          <div>
            <label for="plain">æ¤œç´¢ï¼ˆé€šå¸¸æ–‡å­—åˆ—ï¼‰</label>
            <input class="mini" id="plain" type="text" placeholder="ä¾‹ï¼‰apple">
            <div class="hint">â€» ã“ã¡ã‚‰ã‹ä¸‹ã® <b>æ­£è¦è¡¨ç¾</b> ã®ã„ãšã‚Œã‹ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¸¡æ–¹å…¥ã£ã¦ã„ã‚‹å ´åˆã¯æ­£è¦è¡¨ç¾ã‚’å„ªå…ˆï¼‰ã€‚</div>
          </div>
          <div>
            <label for="regex">æ¤œç´¢ï¼ˆæ­£è¦è¡¨ç¾ï¼‰</label>
            <input class="mini" id="regex" type="text" placeholder="ä¾‹ï¼‰(?i)apple|pine\w+">
            <div class="flags">
              <label class="flag"><input type="checkbox" id="flag_i"> å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ï¼ˆiï¼‰</label>
              <label class="flag"><input type="checkbox" id="flag_g" checked> ã™ã¹ã¦ç½®æ›ï¼ˆgï¼‰</label>
              <label class="flag"><input type="checkbox" id="flag_m"> è¤‡æ•°è¡Œï¼ˆmï¼‰</label>
              <label class="flag"><input type="checkbox" id="flag_s"> . ã‚’æ”¹è¡Œã«ã‚‚ä¸€è‡´ï¼ˆsï¼‰</label>
            </div>
          </div>
        </div>

        <label for="replacement">ç½®æ›å¾Œï¼ˆ\n = æ”¹è¡Œ, \t = ã‚¿ãƒ–ï¼‰</label>
        <input class="mini" id="replacement" type="text" placeholder="ä¾‹ï¼‰ğŸ$&ï¼ˆä¸€è‡´ç®‡æ‰€ï¼‰ ã¾ãŸã¯ ã¿ã‹ã‚“\nã‹ã">
        <div class="hint">æ­£è¦è¡¨ç¾ãƒ¢ãƒ¼ãƒ‰ã§ã¯ $1, $& ãªã©ã®å¾Œæ–¹å‚ç…§ãŒä½¿ãˆã¾ã™ã€‚é€šå¸¸æ–‡å­—åˆ—ãƒ¢ãƒ¼ãƒ‰ã§ã¯ $ ã‚’ãƒªãƒ†ãƒ©ãƒ«ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚</div>

        <div class="toolbar">
          <button class="pill primary" id="run">ç½®æ›ã‚’å®Ÿè¡Œ</button>
          <button class="pill ghost" id="highlight">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
          <button class="pill ghost" id="swap">æ¤œç´¢ã¨ç½®æ›ã‚’å…¥ã‚Œæ›¿ãˆ</button>
          <button class="pill ghost" id="clear">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
          <button class="pill ghost" id="copy">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
          <button class="pill ghost" id="download">.txt ã§ä¿å­˜</button>
        </div>
        <div id="error" class="error" role="status" aria-live="polite"></div>
      </section>

      <!-- RIGHT: preview/result -->
      <section class="card">
        <h2>çµæœ & ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <label for="result">ç½®æ›çµæœï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
        <textarea id="result" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
        <div class="footer">
          <div class="counter"><span id="matchCount" class="stat">0</span> ä»¶ä¸€è‡´</div>
          <div class="sub">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ä¸€è‡´ç®‡æ‰€ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>
        </div>
        <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¼·èª¿è¡¨ç¤ºï¼‰</label>
        <div id="preview" class="preview" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <script>
    // util
    const $ = (id)=>document.getElementById(id);
    const escapeHTML = (s)=>s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    const escapeRegExp = (s)=>s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const interpretEscapes = (s)=> s
      .replace(/\\n/g, "\n")
      .replace(/\\t/g, "\t")
      .replace(/\\r/g, "\r");

    function buildRegex(){
      const reInput = $("regex").value.trim();
      const plain = $("plain").value;
      let flags = ( $("flag_g").checked ? "g" : "" ) + ( $("flag_i").checked ? "i" : "" ) + ( $("flag_m").checked ? "m" : "" ) + ( $("flag_s").checked ? "s" : "" );

      if(reInput){
        // Support inline (?i) style flag prefix for convenience
        let prefixFlags = "";
        const m = reInput.match(/^\(\?([gimsyu]+)\)/i);
        let pattern = reInput;
        if(m){ prefixFlags = m[1]; pattern = reInput.slice(m[0].length); }
        const merged = Array.from(new Set((flags + prefixFlags).split(""))).join("");
        try{ return { regex: new RegExp(pattern, merged), mode: 'regex' }; }
        catch(e){ throw new Error("æ­£è¦è¡¨ç¾ãŒä¸æ­£ã§ã™: " + e.message); }
      }
      if(plain === "") throw new Error("æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆé€šå¸¸æ–‡å­—åˆ— ã¾ãŸã¯ æ­£è¦è¡¨ç¾ï¼‰ã€‚");
      try{ return { regex: new RegExp(escapeRegExp(plain), flags || 'g'), mode: 'plain' }; }
      catch(e){ throw new Error("å†…éƒ¨ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    function highlightPreview(){
      const src = $("source").value;
      const prev = $("preview");
      const err = $("error");
      err.textContent = "";
      let rx, mode;
      try{ ({regex:rx, mode} = buildRegex()); }
      catch(e){ err.textContent = e.message; prev.innerHTML = escapeHTML(src); $("matchCount").textContent = 0; return; }

      if(!rx.global){ // for count/highlight we need global
        const flags = rx.flags.includes('g') ? rx.flags : rx.flags + 'g';
        rx = new RegExp(rx.source, flags);
      }
      let count = 0;
      const out = escapeHTML(src).replace(rx, m=>{ count++; return `<mark>${escapeHTML(m)}</mark>`; });
      prev.innerHTML = out;
      $("matchCount").textContent = count;
    }

    function runReplace(){
      const src = $("source").value;
      const replRaw = $("replacement").value;
      const err = $("error");
      err.textContent = "";
      let rx, mode;
      try{ ({regex:rx, mode} = buildRegex()); }
      catch(e){ err.textContent = e.message; return; }

      let replacement = interpretEscapes(replRaw);
      if(mode === 'plain'){
        // In plain mode, treat $ literally (avoid backref expansion)
        replacement = replacement.replace(/\$/g, "$$");
      }
      try{
        const result = src.replace(rx, replacement);
        $("result").value = result;
        highlightPreview();
      }catch(e){ err.textContent = "ç½®æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message; }
    }

    // Buttons
    $("highlight").addEventListener('click', highlightPreview);
    $("run").addEventListener('click', runReplace);
    $("swap").addEventListener('click', () => {
      const p = $("plain");
      const r = $("replacement");
      const tmp = p.value; p.value = r.value; r.value = tmp;
      highlightPreview();
    });
    $("clear").addEventListener('click', () => {
      $("plain").value = ""; $("regex").value = ""; $("replacement").value = ""; $("result").value = ""; $("error").textContent = ""; $("matchCount").textContent = 0; highlightPreview();
    });
    $("copy").addEventListener('click', async () => {
      const txt = $("result").value || '';
      try{ await navigator.clipboard.writeText(txt); $("error").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"; }
      catch{ $("result").select(); document.execCommand('copy'); $("error").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆå¤ã„APIã‚’ä½¿ç”¨ï¼‰"; }
      setTimeout(()=>$("error").textContent = "", 1600);
    });
    $("download").addEventListener('click', () => {
      const blob = new Blob([$("result").value || ''], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'replace_result.txt'; a.click(); URL.revokeObjectURL(a.href);
    });

    // live preview
    ["source","plain","regex","flag_i","flag_g","flag_m","flag_s"].forEach(id=>$(id).addEventListener('input', highlightPreview));

    // init
    highlightPreview();
  </script>
</body>
</html>
